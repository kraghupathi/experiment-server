#+Title: Implementation of *experiment server* project  
#+Author: Sytems Team
#+SETUPFILE: ../org-templates/level-1.org
#+TAGS: boilerplate(b)
#+EXCLUDE_TAGS: boilerplate
#+OPTIONS: ^:nil
# !/usr/bin/env zsh
# -*- mode: shell-script -*-

* Introduction
  This document contains the implementation of *experiment server* project  
* Implementation
** Steps to Ceate a VM on base4
   - Open terminal login to base4 with the below command:
# sudo apt-get install sshpass

# export SSHPASS="9705651490s"
# sshpass -e ssh -oBatchMode=no modepusravanthi@10.4.12.24
# #+END_SRC  
#    - Enter into the root from the container using the below command.
#+BEGIN_SRC
ssh modepusravanthi@10.4.12.24
sudo su -
#+END_SRC

   - Create a container on base4 with below command:  
#+BEGIN_SRC
vzctl create 31 --ostemplate ubuntu-14.04-x86_64 --ipadd 10.4.12.31 --hostname experiment-server-labs
#+END_SRC

   - Then start the container as:
#+BEGIN_SRC
vzctl start 31
#+END_SRC
   - Enter into the container as :
#+BEGIN_SRC
vzctl enter 31
#+END_SRC
   
** Automation script for the experiment server labs
   - Read the lab names from the file labs.json and clone the labs.

#+BEGIN_SRC python :tangle automation.py
import json
import sys
import os
import os.path
from pprint import pprint
from git import Repo
import git

exp_id = "../exp-ids"
labs = "../exp-server-labs"
sh_script = "../implementation"
id = "data[i][FIELD2]"

# variable to store proxy value
proxy = "http://proxy.iiit.ac.in:8080"

# setup proxy settings to install any package     
os.environ["HTTP_PROXY"] = proxy
os.environ["HTTPS_PROXY"] = proxy

os.makedirs('../exp-server-labs')
os.makedirs('../exp-ids')
os.makedirs('../var/www/')

# os.system("rsync -t" %s % labs.json "../../build/code/implementation")

with open('labs.json') as json_file:
    data = json.load(json_file)
    os.chdir(labs)
    for i in range(4):
        if not os.path.isdir("labs[i]"):
            os.system("git clone %s" % data[i]["FIELD4"])            
            repo_name = data[i]["FIELD4"].split("/")[-1]
            pprint (repo_name)
            
            os.chdir(repo_name)                 
            if not os.path.isdir(repo_name):          
                cmd1 = "make -C src/"
                os.system(cmd1)
                # pprint (cmd)
                #cmd = "cd .."
                os.chdir("..")

            # os.chdir(sh_script)
            # bash_command="sh" + " " + "automation.sh"  
            # os.system(bash_command)
         
                os.chdir(exp_id)
                for j in range(4):
                  repo_id = data[i]["FIELD2"]
                  if not os.path.isdir(exp_id):
                     cmd = "cp -rf %s" % repo_id % exp_id       
                     os.system(cmd)       
                     pprint (data[j]["FIELD2"])
       
#+END_SRC

** Shell script to run makefile in the labs

#+BEGIN_SRC bat : exports both :tangle "automation.sh"  

# labs = "../exp-server-labs"
repo = "data[i]"

for k in ../exp-server-labs;
do 
    # cd ../exp-server-labs
    make -C "$k" || exit 
    cd .. &&
    make -C experiment-server/;cp -r ex/build 

    cd ..
    echo "Finished "
done

#+END_SRC
#+BEGIN_SRC :tangle make
all:
    @$(MAKE) -C subfolder
#+END_SRC
